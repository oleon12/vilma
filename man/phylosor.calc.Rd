% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/phylosor.calc.R
\name{phylosor.calc}
\alias{phylosor.calc}
\title{Phylogenetic Sørensen Similarity (PhyloSor) between communities (cells)}
\usage{
phylosor.calc(
  tree,
  dist,
  method = c("root", "node", "exclude"),
  singleton_overlap = FALSE,
  abundance = FALSE,
  normalize = TRUE
)
}
\arguments{
\item{tree}{A rooted phylogenetic tree of class \code{phylo} with branch lengths.}

\item{dist}{An object of class \code{vilma.dist} (e.g., from \code{points.to.raster()}),
containing species occurrences per grid cell and a template raster.}

\item{method}{Character; PD convention for single-species cases:
\itemize{
\item \code{"root"} – singletons use root→tip; multi-species PD includes root→MRCA (default).
\item \code{"node"} – singletons use terminal branch; multi-species PD is the minimal subtree.
\item \code{"exclude"} – single-species cells are dropped before computing pairwise similarity.
}}

\item{singleton_overlap}{Logical; when two cells share exactly one species:
\itemize{
\item \code{FALSE} – count that single shared species as shared PD under \code{method}.
\item \code{TRUE} – treat that case as no shared PD (similarity = 0).
}
Note: \code{method="exclude"} is incompatible with \code{singleton_overlap = FALSE}.}

\item{abundance}{Logical; if \code{TRUE}, use abundance-weighted PhyloSor by
partitioning shared/unique branch lengths with abundance weights (via
\code{branch.partition.weighted()}). When \code{FALSE} (default), presence–absence is used.}

\item{normalize}{Logical; only relevant when \code{abundance = TRUE}. If \code{TRUE}
(default), per-cell abundances are normalized to relative abundances before
computing edge fractions. If \code{FALSE}, raw counts are used.}
}
\value{
An object of class \code{vilma.beta} with:
\itemize{
\item \code{distribution} – Original species distribution (from \code{dist}).
\item \code{similarity} – PhyloSor similarity as a \code{dist} object (labels = cell IDs).
\item \code{dissimilarity} – \code{1 - similarity} as a \code{dist} object.
\item \code{rasters} – A named list of \code{SpatRaster} layers:
\code{mean.similarity}, \code{mean.dissimilarity},
\code{pcoa.1}, \code{pcoa.2}, \code{ndms.1}, \code{ndms.2}.
\item \code{pcoa.eig} – PCoA eigenvalues (first two axes).
\item \code{ndms.stress} – NMDS stress.
\item \code{calculation.method} – The resolved \code{method}.
}
}
\description{
Computes pairwise PhyloSor similarity among grid cells and returns:
(i) a similarity matrix, (ii) its complementary dissimilarity matrix,
and (iii) rasters summarizing mean similarity/dissimilarity per cell
plus ordination (PCoA and NMDS) axes mapped to space.

Two calculation modes are supported:
\itemize{
\item \strong{Unweighted} (\code{abundance = FALSE}; default): presence–absence PhyloSor.
\item \strong{Weighted} (\code{abundance = TRUE}): edge contributions are
weighted by per-cell species \emph{abundances}. If \code{normalize = TRUE},
abundances are converted to relative abundances within each cell
(so each cell sums to 1), yielding a normalized, 0–1 scaled similarity.
}

The PD convention for single-species cells follows \code{method}:
\code{"root"} uses root→tip distance; \code{"node"} uses the terminal branch;
\code{"exclude"} removes singletons from the analysis. For pairs sharing
exactly one species, behavior is controlled by \code{singleton_overlap}.
}
\details{
Let \eqn{PD_A}, \eqn{PD_B} be (convention-consistent) phylogenetic diversity
of communities A and B, and \eqn{PD_{shared}} their shared branch length.
The classic PhyloSor similarity is:
\deqn{\mathrm{PhyloSor}(A,B) = \frac{2\,PD_{shared}}{PD_A + PD_B}.}

In the unweighted mode, presence–absence is used to compute \eqn{PD} and
\eqn{PD_{shared}}. In the weighted mode, for each tree edge \eqn{e} with length
\eqn{L_e}, the fractions of (relative) abundance descending from \eqn{e} in A and B
are computed (\eqn{p_A(e)}, \eqn{p_B(e)}). These yield three edge-weighted branch-length
sums: shared \eqn{a=\sum_e L_e \min[p_A(e),p_B(e)]}, unique-to-A
\eqn{b=\sum_e L_e \max[p_A(e)-p_B(e),0]}, and unique-to-B
\eqn{c=\sum_e L_e \max[p_B(e)-p_A(e),0]}. The weighted PhyloSor then uses
\eqn{PD_{shared}=a} and \eqn{PD_A+PD_B=2a+b+c}, so
\deqn{\mathrm{PhyloSor}_w(A,B)=\frac{2a}{2a+b+c}.}
With \code{normalize = TRUE}, \eqn{p_\cdot(e)} are computed from relative
abundances (summing to 1 within each cell), keeping the index in \eqn{[0,1]}.

Only species present in both \code{tree} and \code{dist} are used; informative
messages are printed for mismatches. The similarity matrix has diagonal 1; the
dissimilarity matrix is \code{1 - similarity} with diagonal 0.

After computing matrices, each cell is summarized by its mean similarity
(and \code{1 -} that value for mean dissimilarity). Ordinations (PCoA with
Cailliez correction, and NMDS) are done on the dissimilarity matrix; the
first two axes are rasterized to the study grid.
}
\section{Notes}{

\itemize{
\item The tree must be rooted and have branch lengths.
\item \code{abundance = TRUE} calls \code{branch.partition.weighted()}
with \code{normalize} passed through; \code{abundance = FALSE}
uses presence–absence via \code{branch.partition()}.
\item \code{method = "exclude"} removes singletons prior to pairwise
computations; such cells appear as \code{NA} in rasters.
\item Ordinations are applied to dissimilarities; PCoA uses
\code{ape::pcoa(..., correction = "cailliez")}.
}
}

\examples{
\dontrun{
tree <- examplae_tree()
dist <- example_dist()
dist <- points_to_raster(dist)

# Presence–absence PhyloSor (default):
ps <- phylosor.calc(tree, dist)
print(ps)
plot(ps)
view.vilma(ps)

# Abundance-weighted PhyloSor with relative abundances:
ps_w <- phylosor.calc(tree, dist, abundance = TRUE, normalize = TRUE)

# Abundance-weighted without normalization (use raw counts):
ps_wc <- phylosor.calc(tree, dist, abundance = TRUE, normalize = FALSE)
}


}
\references{
Bryant JA, Lamanna C, Morlon H, Kerkhoff AJ, Enquist BJ, Green JL (2008)
Microbes on mountainsides: contrasting elevational patterns of bacterial and plant diversity.
\emph{Proceedings of the National Academy of Sciences} 105:11505–11511. (Introduces the PhyloSor concept/formulation.)

Kembel SW, Cowan PD, Helmus MR, Cornwell WK, Morlon H, Ackerly DD, Blomberg SP, Webb CO (2010)
Picante: R tools for integrating phylogenies and ecology.
\emph{Bioinformatics} 26:1463–1464. (Implements \code{phylosor} and related functions.)

Chiu C-H, Jost L, Chao A (2014)
Phylogenetic beta diversity, similarity, and differentiation measures based on Hill numbers.
\emph{Ecological Monographs} 84:21–44. (Abundance-based extensions and normalization considerations.)

Gower JC (1966)
Some distance properties of latent root and vector methods used in multivariate analysis.
\emph{Biometrika} 53:325–338. (Classical basis of principal coordinates analysis.)

Cailliez F (1983)
The analytical solution of the additive constant problem.
\emph{Psychometrika} 48:305–312. (PCoA negative-eigenvalue correction used here.)

Kruskal JB (1964)
Nonmetric multidimensional scaling: a numerical method.
\emph{Psychometrika} 29:115–129. (Foundational NMDS procedure.)
}
\seealso{
\code{\link{faith.pd}}, \code{\link{unifrac.calc}}, \code{\link{points_to_raster}}
}
\author{
Omar Daniel Leon-Alvarado \url{https://leon-alvarado.weebly.com/}
J. Angel Soto-Centeno \url{https://www.mormoops.com}
}
