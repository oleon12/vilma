% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/phylo.beta.R
\name{phylo.beta}
\alias{phylo.beta}
\title{Phylogenetic Beta Diversity Partitioning (β_sor, β_sim, β_sne)}
\usage{
phylo.beta(tree, dist, method = c("unweighted", "weighted"), normalize = TRUE)
}
\arguments{
\item{tree}{A rooted phylogenetic tree of class \code{phylo} with branch lengths.}

\item{dist}{An object of class \code{vilma.dist} containing species-by-cell
occurrences (columns typically: \code{Sp}, \code{Lon}, \code{Lat}, \code{Cell})
and a reference grid.}

\item{method}{Character, either \code{"unweighted"} (default) or \code{"weighted"}.
See \emph{Mathematics} for definitions.}

\item{normalize}{Logical; if \code{TRUE} (default) and \code{method = "weighted"},
converts within-cell abundances to relative abundances (sum to 1) prior to
edge aggregation. Ignored for \code{method = "unweighted"}.}
}
\value{
An object of class \code{vilma.beta}:
\itemize{
\item \code{total.dissimilarity} – \code{dist} object of \eqn{\beta_{\mathrm{sor}}}.
\item \code{turnover} – \code{dist} object of \eqn{\beta_{\mathrm{sim}}}.
\item \code{nestedness} – \code{dist} object of \eqn{\beta_{\mathrm{sne}}}.
\item \code{rasters} – named list with:
\itemize{
\item \code{mean.total}, \code{mean.turnover}, \code{mean.nestedness}.
\item PCoA rasters: \code{total.pcoa.1}, \code{total.pcoa.2},
\code{turnover.pcoa.1}, \code{turnover.pcoa.2},
\code{nestedness.pcoa.1}, \code{nestedness.pcoa.2}.
\item NMDS rasters: \code{total.ndms.1}, \code{total.ndms.2},
\code{turnover.ndms.1}, \code{turnover.ndms.2},
\code{nestedness.ndms.1}, \code{nestedness.ndms.2}.
}
\item \code{stats} – data frame summarizing eigenvalues (PCoA) and stress (NMDS).
\item \code{calculation.method} – resolved \code{method} and whether normalization was applied.
\item \code{algorithm} – the string \code{"PhyloBeta"}.
}
}
\description{
Computes pairwise \strong{phylogenetic} beta diversity between communities (cells)
by partitioning total dissimilarity into \strong{turnover} and \strong{nestedness}
components, using branch-length–based analogs of Baselga's decomposition.

Two modes are available:
\itemize{
\item \code{method = "unweighted"} – presence/absence on the tree.
\item \code{method = "weighted"} – relative-abundance weighting along edges.
}
Optional \code{normalize = TRUE} (default) rescales per-community abundances to
sum to 1 before edge aggregation, so indices lie in \eqn{[0,1]} and are comparable
across communities with different total abundances.
}
\details{
Only species present in both \code{tree} and \code{dist} are used; informative
messages report mismatches. Pairwise dissimilarities are computed for all
cell combinations. Ordinations (PCoA with Cailliez correction; NMDS) are run
on each dissimilarity to obtain spatial axes, and per-cell means are computed
by averaging off-diagonal dissimilarities.
}
\section{Mathematics}{

Let \eqn{E} be the set of tree edges with lengths \eqn{L_e}.
For two communities (cells) \eqn{A} and \eqn{B}, define for each edge \eqn{e}
the fraction of the community that lies \emph{below} that edge:
\itemize{
\item \emph{Unweighted (presence/absence):}
\eqn{p_A(e) = \mathbf{1}\{\text{any descendant tip of } e \text{ in } A\}},
and similarly \eqn{p_B(e)}.
\item \emph{Weighted (relative abundance):}
\eqn{p_A(e) = \sum_{i \in \text{tips}(e)} \tilde{a}_i}, where
\eqn{\tilde{a}_i = a_i / \sum_j a_j} are per-tip relative abundances in
community \eqn{A} (and analogously \eqn{p_B(e)} for \eqn{B}).
}
From these, define branch-length partitions:
\deqn{a = \sum_{e \in E} L_e \, \min\{p_A(e), p_B(e)\},}
\deqn{b = \sum_{e \in E} L_e \, \max\{p_A(e) - p_B(e),\, 0\}, \qquad
      c = \sum_{e \in E} L_e \, \max\{p_B(e) - p_A(e),\, 0\}.}
The phylogenetic beta components are then
\deqn{\beta_{\mathrm{sor}} = \frac{b + c}{\,2a + b + c\,}, \qquad
      \beta_{\mathrm{sim}} = \frac{\min(b,c)}{\,a + \min(b,c)\,}, \qquad
      \beta_{\mathrm{sne}} = \beta_{\mathrm{sor}} - \beta_{\mathrm{sim}}.}
These reduce to Baselga's (2010) PA formulas when \eqn{p_A(e), p_B(e) \in \{0,1\}}.
By construction \eqn{0 \le \beta_{\mathrm{sim}}, \beta_{\mathrm{sne}}, \beta_{\mathrm{sor}} \le 1}
and \eqn{\beta_{\mathrm{sor}} = \beta_{\mathrm{sim}} + \beta_{\mathrm{sne}}}.
}

\section{Implementation Notes}{

\itemize{
\item Presence/absence mode is obtained by setting \eqn{p_A(e), p_B(e)} to
edge-level indicators of occupancy.
\item In weighted mode, setting \code{normalize = TRUE} yields relative-abundance
fractions (sum to 1 per cell) before edge aggregation; \code{FALSE} uses
raw counts and can emphasize differences in total sampling intensity.
\item The distance matrices are symmetric with zero diagonals; internal checks
confirm bounds and \eqn{\beta_{\mathrm{sor}} = \beta_{\mathrm{sim}} + \beta_{\mathrm{sne}}}.
\item A progress bar can be used during pairwise loops; when present, it should
be closed with \code{on.exit(close(pb), add = TRUE)}.
}
}

\examples{
\dontrun{
tree <- examplae_tree()
dist <- example_dist()
dist <- points_to_raster(dist)

# Presence/absence (Baselga-style) phylogenetic β
pb_unw <- phylo.beta(tree, dist, method = "unweighted")
print(pb_unw)
plot(pb_unw)
view.vilma(pb_unw)

# Abundance-weighted phylogenetic β (relative abundances by default)
pb_w <- phylo.beta(tree, dist, method = "weighted", normalize = TRUE)
}

}
\references{
Baselga, A. (2010). Partitioning the turnover and nestedness components of beta diversity.
\emph{Global Ecology and Biogeography}, 19, 134–143.
Leprieur, F., Albouy, C., de Bortoli, J., Cowman, P.F., Bellwood, D.R., & Mouillot, D. (2012).
Quantifying phylogenetic beta diversity: distinguishing turnover of lineages from PD gradients.
\emph{PLoS ONE}, 7(8), e42760.
Nipperess, D.A., & Matsen IV, F.A. (2013). The mean and variance of phylogenetic diversity under rarefaction.
\emph{Methods in Ecology and Evolution}, 4, 566–572.
}
\seealso{
\code{\link{unifrac.calc}}, \code{\link{phylosor.calc}}, \code{\link{faith.pd}},
\code{\link{points_to_raster}}
}
\author{
Omar Daniel Leon-Alvarado \url{https://leon-alvarado.weebly.com/}
J. Angel Soto-Centeno \url{https://www.mormoops.com}
}
