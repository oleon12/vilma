% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/beta.mpd.R
\name{beta.mpd}
\alias{beta.mpd}
\title{Between-community Mean Pairwise Distance (betaMPD) between communities (cells)}
\usage{
beta.mpd(
  tree,
  dist,
  mpd.method = c("exclude", "root", "node"),
  abundance = FALSE,
  exclude.conspecific = FALSE,
  normalize = FALSE,
  scale01 = FALSE
)
}
\arguments{
\item{tree}{A rooted phylogenetic tree of class \code{phylo} with branch lengths.}

\item{dist}{An object of class \code{vilma.dist} (e.g., from \code{points.to.raster()}),
containing species occurrences per grid cell and a template raster.}

\item{mpd.method}{Character; how within-cell MPD is handled when
\code{normalize = TRUE}. One of:
\itemize{
\item \code{"exclude"} - single-species cells are excluded (Default).
\item \code{"root"} - singletons use root-to-tip distance.
\item \code{"node"} - singletons use tip-to-nearest-node branch.
}
Ignored if \code{normalize = FALSE}.}

\item{abundance}{Logical; if \code{TRUE}, compute abundance-weighted betaMPD using
relative abundances within each cell. Default \code{FALSE}.}

\item{exclude.conspecific}{Logical; if \code{TRUE}, conspecific matches across
cells are excluded from betaMPD (and abundance weights are renormalized in the
weighted case). Default \code{FALSE}.}

\item{normalize}{Logical; if \code{TRUE}, return the relative (dimensionless)
index \eqn{betaMPD_rel = betaMPD / ((MPD_A + MPD_B)/2)},
where within-cell MPDs follow \code{mpd.method} and \code{abundance}. Default \code{FALSE}.}

\item{scale01}{Logical; if \code{TRUE}, divide the final betaMPD matrix by its
maximum (over all finite entries) to rescale values to \eqn{[0,1]} for
visualization. This is a display transform; it does not change the underlying
metric. Default \code{FALSE}.}
}
\value{
An object of class \code{vilma.beta}, a list with:
\itemize{
\item \code{distribution} - Original species distribution (from \code{dist}).
\item \code{bMPD} - Pairwise betaMPD as a \code{dist} object (labels are cell IDs).
\item \code{rasters} - A named list of \code{SpatRaster} layers:
\itemize{
\item \code{mean.bMPD} - Raster of mean betaMPD per cell (diagonal excluded).
\item \code{pcoa.1}, \code{pcoa.2} - PCoA axes 1 and 2 mapped to cells (from \code{bMPD}).
\item \code{nmds.1}, \code{nmds.2} - NMDS axes 1 and 2 mapped to cells (from \code{bMPD}).
}
\item \code{pcoa.eig} - PCoA eigen values of the first two axes.
\item \code{nmds.stress} - NMDS stress value.
\item \code{calculation.method} - The resolved method used (see Notes).
\item \code{algorithm} - The string \code{"beta.mpd"}.
}
}
\description{
Computes pairwise between-community MPD among grid cells and returns:
(i) a betaMPD matrix (larger = more phylogenetically distant), and
(ii) rasters summarizing mean betaMPD per cell as well as
ordination (PCoA and NMDS) axes mapped to space.

Two variants are provided:
\itemize{
\item Unweighted (presence/absence) - betaMPD is the mean patristic
distance over all cross-cell species pairs.
\item Weighted (abundances) - betaMPD is the expectation of the
patristic distance under within-cell relative abundance weights.
}
Optionally, the result can be normalized by the mean within-cell MPDs and/or
rescaled to the unit interval for visualization.
}
\details{
Let \eqn{D_{sp}} be the patristic (cophenetic) distance matrix among species.
For two cells with species sets \eqn{S_A} and \eqn{S_B}:

Unweighted betaMPD:
\deqn{betaMPD(A,B) = mean\{ d(i,j) : i \in S_A,\ j \in S_B \}.}

Weighted betaMPD (relative abundances \eqn{p_A}, \eqn{p_B}):
\deqn{betaMPD_w(A,B) = \sum_{i \in S} \sum_{j \in S} p_A(i)\, p_B(j)\, d(i,j)
     = \mathbf{p}_A^\top D_{sp}\, \mathbf{p}_B.}

If \code{exclude.conspecific = TRUE}, conspecific pairs are removed; in the weighted
case, weights are renormalized within each cell. Comparisons involving an empty cell
return \code{NA}. The diagonal of the returned betaMPD matrix is set to 0 (purely
between-community distance).

When \code{normalize = TRUE}, each pairwise value is divided by the mean of the
corresponding within-cell MPDs, computed via \code{mpd.calc} with the provided
\code{mpd.method} and \code{abundance} so that numerator and denominator are
consistent. Note that \code{normalize} produces a dimensionless ratio (not bounded
to \eqn{[0,1]}). If \code{scale01 = TRUE}, the final matrix (after any normalization)
is divided by its maximum for plotting.
}
\section{Notes}{

\itemize{
\item The tree must be rooted and have branch lengths.
\item Only species present in both \code{tree} and \code{dist} are used; informative
messages are printed for mismatches.
\item \code{normalize = TRUE} uses \code{mpd.calc} internally with \code{mpd.method}
and \code{abundance} to compute within-cell MPDs for the denominator.
\item \code{scale01 = TRUE} rescales the final matrix by its maximum for visualization;
values then lie in \eqn{[0,1]} but are not comparable across datasets/trees.
}
}

\examples{
\dontrun{
tree <- examplae_tree()
dist <- example_dist()
dist <- points_to_raster(dist)
# Unweighted betaMPD (raw, in tree units)
bm <- beta.mpd(tree, dist, abundance = FALSE)
print(bm)
plot(bm)
view.vilma(bm)

# Weighted betaMPD (relative abundances)
bm_w <- beta.mpd(tree, dist, abundance = TRUE)

# Relative (normalized) betaMPD
bm_rel <- beta.mpd(tree, dist, abundance = FALSE,
                   normalize = TRUE, mpd.method = "exclude")

# Rescale to 0-1 for visualization
bm_scaled <- beta.mpd(tree, dist, abundance = TRUE,
                      normalize = FALSE, scale01 = TRUE)
}

}
\references{
Webb CO, Ackerly DD, McPeek MA, Donoghue MJ (2002).
Phylogenies and community ecology. Annual Review of Ecology and Systematics, 33, 475-505.

Miller ET, Farine DR, Trisos CH (2017).
Phylogenetic community structure metrics and null models: a review with new methods.
Ecology Letters, 20(7), 807-818.
}
\seealso{
\code{\link{mpd.calc}}, \code{\link{beta.mntd}}, \code{\link{phylosor.calc}}, \code{\link{unifrac.calc}}
}
\author{
Omar Daniel Leon-Alvarado \url{https://leon-alvarado.weebly.com/}
J. Angel Soto-Centeno \url{https://www.mormoops.com}
}
