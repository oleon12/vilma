% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/unifrac.calc.R
\name{unifrac.calc}
\alias{unifrac.calc}
\title{UniFrac Phylogenetic Dissimilarity between communities (cells)}
\usage{
unifrac.calc(tree, dist, method = c("unweighted", "weighted"))
}
\arguments{
\item{tree}{A rooted phylogenetic tree of class \code{phylo} with branch lengths.}

\item{dist}{An object of class \code{vilma.dist} (e.g., from \code{points.to.raster()}),
containing species occurrences per grid cell and a template raster.}

\item{method}{Character; UniFrac variant to compute:
\itemize{
\item \code{"unweighted"} – presence/absence UniFrac (Default).
\item \code{"weighted"} – normalized weighted UniFrac using relative abundances.
}}
}
\value{
An object of class \code{vilma.beta}, a list with:
\itemize{
\item \code{distribution} – Original species distribution (from \code{dist}).
\item \code{UniFrac} – UniFrac dissimilarity as a \code{dist} object (labels are cell IDs).
\item \code{rasters} – A named list of \code{SpatRaster} layers:
\itemize{
\item \code{mean.unifrac} – Raster of mean UniFrac per cell (diagonal excluded).
\item \code{pcoa.1}, \code{pcoa.2} – PCoA axes 1 and 2 mapped to cells (from dissimilarity).
\item \code{ndms.1}, \code{ndms.2} – NMDS axes 1 and 2 mapped to cells (from dissimilarity).
}
\item \code{pcoa.eig} – PCoA eigen values of the two first axes.
\item \code{ndms.stress} – NMDS stress value.
\item \code{calculation.method} – The resolved \code{method} used.
\item \code{algorithm} – The string \code{"UniFrac"}.
}
}
\description{
Computes pairwise UniFrac distances among grid cells and returns:
(i) a dissimilarity matrix, and (ii) convenient rasters summarizing
mean dissimilarity per cell as well as ordination (PCoA and NMDS)
axes mapped to space.

The computation follows the classic UniFrac definitions:
when \code{method = "unweighted"}, distances depend only on presence/absence;
when \code{method = "weighted"}, distances are normalized and depend on
the relative abundances of taxa in each cell.
}
\details{
Let \eqn{E} be the set of tree edges with lengths \eqn{w_e}.
For two communities (cells) \eqn{A} and \eqn{B}, define \eqn{U_e(A)} and \eqn{U_e(B)}
as indicators that edge \eqn{e} has at least one descendant tip present in
community \eqn{A} (or \eqn{B}), respectively.

\strong{Unweighted UniFrac} (presence/absence) is:
\deqn{\mathrm{UniFrac}_{\mathrm{unw}}(A,B) =
      \frac{\sum_{e \in E} w_e \cdot \mathbf{1}\{ U_e(A) + U_e(B) = 1 \}}
           {\sum_{e \in E} w_e \cdot \mathbf{1}\{ U_e(A) + U_e(B) \ge 1 \}}.}

\strong{Weighted UniFrac} (normalized; relative abundances) defines the fraction of
abundance below each edge as \eqn{D_A(e)} and \eqn{D_B(e)} (each in \eqn{[0,1]}), and uses:
\deqn{\mathrm{UniFrac}_{\mathrm{w}}(A,B) =
      \frac{\sum_{e \in E} w_e \, |D_A(e) - D_B(e)|}
           {\sum_{e \in E} w_e \, [D_A(e) + D_B(e)]}.}

Only species shared between \code{tree} and \code{dist} are used; informative
messages are printed for mismatches. The returned distance matrix has diagonal 0.

After computing the matrix, the function summarizes each cell by its mean
dissimilarity to all other cells and performs ordinations on the dissimilarity
matrix using PCoA (with Cailliez correction) and NMDS, returning the first
two axes rasterized to the study grid.
}
\section{Notes}{

\itemize{
\item The tree must be rooted and have branch lengths.
\item Only species present in both \code{tree} and \code{dist} are used.
\item Ordinations are performed on the dissimilarity matrix. PCoA uses
\code{ape::pcoa(..., correction = "cailliez")} to handle non-Euclidean cases.
\item \code{method = "weighted"} implements the \emph{normalized} weighted UniFrac
(values in \eqn{[0,1]}), based on relative abundances.
}
}

\examples{
\dontrun{
tree <- examplae_tree()
dist <- example_dist()
dist <- points_to_raster(dist)

# Unweighted UniFrac (presence/absence)
uf_unw <- unifrac.calc(tree, dist, method = "unweighted")
print(uf_unw)
plot(uf_unw)
view.vilma(uf_unw)

# Weighted (normalized) UniFrac (relative abundances)
uf_w <- unifrac.calc(tree, dist, method = "weighted")
}


}
\references{
Lozupone, C., & Knight, R. (2005). UniFrac: a new phylogenetic method for
comparing microbial communities. \emph{Applied and Environmental Microbiology}, 71(12), 8228–8235.

Lozupone, C., Hamady, M., Kelley, S.T., & Knight, R. (2007). Quantitative and
qualitative beta diversity measures lead to different insights into factors that
structure microbial communities. \emph{Applied and Environmental Microbiology}, 73(5), 1576–1585.

Chen, J., Bittinger, K., Charlson, E.S., et al. (2012). Associating microbiome
composition with environmental covariates using generalized UniFrac distances.
\emph{Bioinformatics}, 28(16), 2106–2113.
}
\seealso{
\code{\link{phylosor.calc}}, \code{\link{faith.pd}}, \code{\link{points_to_raster}}
}
\author{
Omar Daniel Leon-Alvarado \url{https://leon-alvarado.weebly.com/}
J. Angel Soto-Centeno \url{https://www.mormoops.com}
}
